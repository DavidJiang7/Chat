<link rel="stylesheet" href="~/Content/CSS/userChat.css" />
<link rel="stylesheet" href="~/Content/CSS/iconfont.css" />
@*<link rel="stylesheet" href="~/Content/bootstrap.min.css" />*@
<div id="chat" class="ui-widget-content">
    <div class="operation">
        <p class="titleImg"><img id="UserImg" src=""><i id="UserName"></i></p>
    </div>
    <div class="chatMain">
        <ul class="chatMainContentUl"></ul>
        <div class="chatMainSendContent">
            <i class="icon"></i>
            <textarea class="chatMainSendInput"></textarea>
            <button class="sendMegBtn">发送</button>
        </div>
    </div>
</div>
<button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
    登录
</button>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="width:400px;height:400px;margin:200px auto;">
            <!--下面是用户名输入框-->
            <div class="input-group" style="margin-top: 110px;">
                <span class="input-group-addon icon iconfont icon-user"></span>
                <input id="userName" type="text" class="form-control" placeholder="用户名" aria-describedby="basic-addon1">
            </div>
            <br>
            <!--下面是密码输入框-->
            <div class="input-group">
                <span class="input-group-addon icon iconfont icon-mima"></span>
                <input id="passWord" type="password" class="form-control" placeholder="密码" aria-describedby="basic-addon1">
            </div>
            <br>
            <!--下面是登陆按钮,包括颜色控制-->
            <div class="input-group">
                <button type="button" style="width:280px;" class="signIn btn btn-danger">登 录</button>
            </div>
        </div>
    </div>
</div>
<div id="refresh">
    <div class="refresh">
        <div class="refreshContent">
            <p>页面刷新完成后，将会重新分配客服，是否刷新？</p>
            <button class="refreshBtn sure" onclick="sureRender()" style="margin-right: 50px;">
                确定
            </button>
            <button class="refreshBtn nosure" onclick="nosureRender()">取消</button>
        </div>
    </div>
</div>
<script src="~/Content/JS/jquery-3.1.1.min.js"></script>
<script src="~/Content/JS/jquery-ui.js"></script>
<script src="~/Content/JS/bootstrap.min.js"></script>

<script>
    var sendMegBtn = $('.sendMegBtn');
    //用户输入内容框
    var chatMainSendInput = $('.chatMainSendInput');

    //enter发送信息
    $(document).keyup(function (e) {
        if ($.trim(chatMainSendInput.val()) == "") {
            chatMainSendInput.val("");
        }
        if (e.keyCode == 13 && $.trim(chatMainSendInput.val()) != "") {
            SendMessage();
        }
    })
    var common = {
        //个位数补零
        Appendzero: function (obj) {
            if (obj < 10) return "0" + obj; else return obj;
        },
        //滚动条始终底部
        scrollBottom: function (obj) {
            obj.scrollTop(obj[0].scrollHeight);
        },
        Connected: function (meaasge) {
            var div = '<li class="protMessage">' + meaasge + '</li>';
            $('.chatMainContentUl').append(div);
        },
        userRender: function (username, message) {
            //        当前时间
            var myDate = new Date();
            var year = myDate.getFullYear();
            var month = myDate.getMonth() + 1;
            var day = myDate.getDate();
            var hour = myDate.getHours();
            var minute = myDate.getMinutes();
            var second = myDate.getSeconds();

            //用户对话框
            var userchat =
                '<li class="chatMainContentLi chatMainContentLiRight">' +
                '<img src="' + UserImg + '"/>' +
                '<div class="chatMainContentLiTime chatMainContentLiTimeRight">' +
                '<ul><li><p>' + year + '/' + common.Appendzero(month) + '/' + common.Appendzero(day) + '</p></li>' +
                '<li><p>' + common.Appendzero(hour) + ':' + common.Appendzero(minute) + ':' + common.Appendzero(second) + '</p></li>' +
                '<li><p>' + username + '</p></li></ul>' +
                '<div class="chatMainContentLiLear chatMainContentLiRight">' +
                '<span class="chatMainContentLiChat chatMainContentLiChatRight">' + message + '</span>' +
                '<div class="triangle-up triangle-upRight"></div>' +
                '</div></div>' +
                '</li>';
            $('.chatMainContentUl').append(userchat);
            common.scrollBottom($('.chatMainContentUl'));

        },
        servRender: function (username, message) {
            //        当前时间
            var myDate = new Date();
            var year = myDate.getFullYear();
            var month = myDate.getMonth() + 1;
            var day = myDate.getDate();
            var hour = myDate.getHours();
            var minute = myDate.getMinutes();
            var second = myDate.getSeconds();
            //用户对话框
            var servchat =
                '<li class="chatMainContentLi chatMainContentLiLeft">' +
                '<img src="' + ServiceImg + '"/>' +
                '<div class="chatMainContentLiTime chatMainContentLiTimeLeft">' +
                '<ul><li><p>' + username + '</p></li>' +
                '<li><p>' + year + '/' + common.Appendzero(month) + '/' + common.Appendzero(day) + '</p></li>' +
                '<li><p>' + common.Appendzero(hour) + ':' + common.Appendzero(minute) + ':' + common.Appendzero(second) + '</p></li></ul>' +
                '<div class="chatMainContentLiLear chatMainContentLiLeft">' +
                '<span class="chatMainContentLiChat chatMainContentLiChatLeft">' + message + '</span>' +
                '<div class="triangle-up triangle-upLeft"></div>' +
                '</div></div>' +
                '</li>';
            $('.chatMainContentUl').append(servchat);
            common.scrollBottom($('.chatMainContentUl'));
        }
    }
    //function Connected(userName) {
    //    var div = '<div class="protMessage">已为您分配客服：'+userName+'</div>';
    //    $('body').append(div);
    //}
    //function loseUserWarm() {
    //    var div = '<div class="protMessage">网络繁忙，用户已下线</div>';
    //    $('body').append(div);
    //}
    //function UserDisconnected(username) {
    //    var div = '<div class="protMessage">网络繁忙，用户已下线</div>';
    //    $('body').append(div);
    //    $.cookie('username', username);
    //}
    function addNewClientTagToPage(UserConnectionId, userName, img) {
        var div = '<div class="protMessage">用户已上线</div>';
        $('body').append(div);
        //setCookie(UserConnectionId, userName, img);
    }
    //  F5刷新
    $(document).keydown(function (e) {
        if (e.keyCode == 116) {
            if (e && e.preventDefault) {
                //非IE
                e.preventDefault();
            } else {
                //IE
                window.event.returnValue = false;
            }
            $('#refresh').show();
        }
    })
    //  刷新确定函数
    function nosureRender() {
        $('#refresh').hide();
    }
    //  刷新取消函数
    function sureRender() {
        location.reload();
    }

</script>


@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        var UserUserName = "";
        var UserUserId = 0;
        var UserNickName = "";
        var UserImg = "";
        var ServiceConnectionid = "";
        var ServiceUsername = "";
        var ServiceImg = "";
        //   登录验证
        $('.signIn').click(function () {
            var username = $('#userName').val();
            var password = $('#passWord').val();
            //        console.log(username +'---'+password)
            $.ajax({
                type: 'post',
                url: '/user/loginapi',
                dataType: 'json',
                data: { username: username, password: password },
                success: function (data) {
                    if (data.Code == 0) {
                        //                 console.log(data.Data.UserName)
                        $('.btn').hide();
                        $('.fade').css({ opacity: 0, display: 'none' });
                        $('#chat').show();
                        UserUserName = data.Data.UserName;
                        UserUserId = data.Data.UserId;
                        UserNickName = data.Data.NickName;
                        UserImg = data.Data.Img;
                        $("#UserImg").attr('src', data.Data.Img);
                        $("#UserName").text(data.Data.UserName);
                        // Start the connection.
                        $.connection.hub.start().done(function () {
                            //客户链接signalr服务器，当登录状态链接失败时，后台会调用loginWarm
                            chat.server.uConnect(UserUserId, UserUserName, UserImg);
                            //绑定发送信息函数
                            $('.sendMegBtn').click(SendMessage);
                        });
                    }
                    else {
                        alert(data.Message);
                    }
                }
            });
        });
        function loseService() {
            UserUserName = "";
            UserUserId = 0;
            UserNickName = "";
            UserImg = "";
            ServiceConnectionid = "";
            ServiceUsername = "";
            ServiceImg = "";
            $('#refresh').show();//刷新提示
        }
        // Reference the auto-generated proxy for the hub.
        var chat = $.connection.chatHub;
        // Create a function that the hub can call back to display messages.
        chat.client.addNewMessageToPage = common.servRender;
        chat.client.busy = function () {
            //alert("抱歉！客服正处于忙碌状态！请稍后刷新重试！");
            common.Connected("抱歉！客服正处于忙碌状态！请稍后刷新重试！");
        };
        chat.client.loginWarm = function () {
            //alert(UserUserName + "，您的登录状态已失效！请重新登录！");
            common.Connected(UserUserName + "，您的登录状态已失效！请重新登录！");
            //window.close();
            //跳转到登录页面代码
        };
        chat.client.onUserDisconnected = function (username) {
            //掉线提示
            //var div = '<div class="protMessage">警告！' + UserUserName + '，您的账户已经在其他地方登录！</div>';
            //$('body').append(div);
            common.Connected('警告！' + UserUserName + '，您的账户已经在其他地方登录！');
            loseService();
        };
        chat.client.onConnected = function (serviceconnectionid, username, img) {
            //var div = '<div class="protMessage">已为您分配客服：' + username + '</div>';
            //$('body').append(div);
            common.Connected('已为您分配客服:' + username);
            ServiceConnectionid = serviceconnectionid;
            ServiceUsername = username;
            ServiceImg = img;
        };
        chat.client.loseServiceWarm = function () {
            //提示用户客服已经掉线，刷新页面，重新链接
            //var div = '<div class="protMessage">抱歉！为您分配的客服 ' + ServiceUserName + ' 可能由于网络原因已经掉线，请刷新重试！</div>';
            //$('body').append(div);
            common.Connected('抱歉！为您分配的客服 ' + ServiceUsername + ' 已经掉线，请刷新重试！');
            //loseService();
            common.scrollBottom($('.chatMainContentUl'));
        };
        function SendMessage() {
            // Call the Send method on the hub.
            if (ServiceConnectionid != "" && UserUserName != "" && $.trim($('.chatMainSendInput').val()) != "") {
                chat.server.uSend(ServiceConnectionid, UserUserName, $('.chatMainSendInput').val());
                common.userRender(UserUserName, $('.chatMainSendInput').val());
                $('.chatMainSendInput').val('').focus();
            }
        }
    </script>
}